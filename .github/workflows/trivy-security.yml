name: "Trivy Container Security"

on:
  push:
    branches: [ main, sec764-w1 ]
  pull_request:
    branches: [ main ]

jobs:
  scan-backend:
    name: Scan Backend Container
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create temp .env for build
        run: |
          echo "PORT=5001" > server/.env
          echo "MONGO_URI=mongodb://test" >> server/.env
      
      - name: Build Backend Image
        run: docker build -t backend:test ./server
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'backend:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail the build
        continue-on-error: true
      
      # Simplified summary without Docker run command
      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ³ Backend Container Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scan executed for security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "Check logs above for detailed results" >> $GITHUB_STEP_SUMMARY

  scan-frontend:
    name: Scan Frontend Container
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create temp .env for build
        run: |
          echo "VITE_API_URL=http://localhost:5001" > client/.env
      
      - name: Build Frontend Image
        run: docker build -t frontend:test ./client
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frontend:test'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸŽ¨ Frontend Container Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "Trivy scan executed for security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "Check logs above for detailed results" >> $GITHUB_STEP_SUMMARY